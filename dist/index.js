#!/usr/bin/env node
import e,{AxiosError as t}from"axios";import{McpServer as s}from"@modelcontextprotocol/sdk/server/mcp.js";import{StdioServerTransport as r}from"@modelcontextprotocol/sdk/server/stdio.js";import{z as a}from"zod";const i="jira-mcp",n="default",o=(process.env.JIRA_ACCEPTANCE_CRITERIA_FIELD||"").trim(),c="https://auth.atlassian.com/oauth/token";let u,d=null;async function l(){if(void 0!==u)return u;try{u=await import("keytar")}catch{u=null}return u}function p(e){let t;try{t=new URL(e)}catch{throw new Error("baseUrl must be a valid URL like https://your-domain.atlassian.net")}const s=t.pathname.replace(/\/+$/,"");return`${t.origin}${s}`}async function m(t,s,r){const a=await e.post(c,{t:"refresh_token",i:t,o:s,u:r},{headers:{"Content-Type":"application/json"}});return{accessToken:a.data.l,refreshToken:a.data.u,expiresIn:a.data.p}}async function y(t){return(await e.get("https://api.atlassian.com/oauth/token/accessible-resources",{headers:{Authorization:`Bearer ${t}`,Accept:"application/json"}})).data}async function h(e,t){const s=await y(e);if(0===s.length)throw new Error("No accessible Jira sites found. Make sure your OAuth app has the correct scopes and you have granted access.");if(t){const e=p(t),r=s.find(t=>p(t.url)===e);if(r)return{cloudId:r.id,siteName:r.name,siteUrl:r.url};throw new Error(`Site ${t} not found in accessible resources. Available sites: ${s.map(e=>e.url).join(", ")}`)}const r=s[0];if(!r)throw new Error("No accessible Jira resources found");return{cloudId:r.id,siteName:r.name,siteUrl:r.url}}async function f(){if(d){if("oauth"===d.type&&d.expiresAt&&d.refreshToken){if(Date.now()>=d.expiresAt-3e5)try{const e=await m(d.clientId,d.clientSecret,d.refreshToken);d={...d,accessToken:e.accessToken,refreshToken:e.refreshToken||d.refreshToken,expiresAt:Date.now()+1e3*e.expiresIn}}catch(e){console.error("Failed to refresh OAuth token:",e)}}return d}const e=function(){const e=process.env.JIRA_OAUTH_CLIENT_ID,t=process.env.JIRA_OAUTH_CLIENT_SECRET,s=process.env.JIRA_OAUTH_ACCESS_TOKEN,r=process.env.JIRA_OAUTH_REFRESH_TOKEN,a=process.env.JIRA_CLOUD_ID;return e&&t&&s&&a?{type:"oauth",clientId:e,clientSecret:t,accessToken:s,refreshToken:r,cloudId:a}:null}();if(e)return e;const t=function(){const e=process.env.JIRA_BASE_URL,t=process.env.JIRA_EMAIL,s=process.env.JIRA_API_TOKEN;return e&&t&&s?{type:"basic",baseUrl:p(e),email:t,apiToken:s}:null}();if(t)return t;const s=await async function(){const e=await l();if(!e)return null;const t=await e.getPassword(i,n);if(!t)return null;try{const e=JSON.parse(t);return"basic"===e.type?{...e,baseUrl:p(e.baseUrl)}:e}catch{return null}}();if(s)return s;throw new Error("MISSING_AUTH")}async function I(e,t){if(d=e,!t)return;const s=await l();if(!s)throw new Error("Keytar is not available to persist credentials.");await s.setPassword(i,n,JSON.stringify(e))}function w(t){return"basic"===t.type?e.create({baseURL:t.baseUrl,auth:{username:t.email,password:t.apiToken},headers:{Accept:"application/json"}}):e.create({baseURL:`https://api.atlassian.com/ex/jira/${t.cloudId}`,headers:{Authorization:`Bearer ${t.accessToken}`,Accept:"application/json"}})}function g(e){if(!e)return"";if(Array.isArray(e))return e.map(g).filter(Boolean).join("\n").trim();if("string"==typeof e.text)return e.text;if(Array.isArray(e.content)){return e.content.map(g).filter(Boolean).join("paragraph"===e.type?"\n":" ").trim()}return""}function _(e){if("string"==typeof e)return e;if("number"==typeof e)return String(e);if(e&&"object"==typeof e){const t=g(e);if(t)return t}return""}function k(e){return{type:"doc",version:1,content:[{type:"paragraph",content:[{type:"text",text:e}]}]}}function j(e){const t=e?.fields||{},s=_(t.description),r=o?_(t[o]):"";return{key:e?.key??"",summary:t.summary??"",description:s,acceptanceCriteria:r||null}}function v(e){const t=e?.fields||{};return{key:e?.key??"",summary:t.summary??"",status:t.status?.name??""}}function S(){const e=["summary","description"];return o&&e.push(o),e}function b(e){if(e instanceof t){const t=e.response?.status,s=e.response?.data;return`Jira API error${t?` (${t})`:""}: ${("string"==typeof s?s:JSON.stringify(s,null,2))||e.message}`}return e instanceof Error?e.message:"Unknown error"}function A(e){if(e instanceof Error&&"MISSING_AUTH"===e.message)return{error:"unauthorized",message:"Jira credentials are missing. Provide credentials explicitly to authenticate."};if(e instanceof t){const t=e.response?.status;return 401===t?{error:"unauthorized",message:"Jira credentials are missing or invalid. If using OAuth, the token may have expired."}:403===t?{error:"forbidden",message:"You do not have permission to access this Jira resource."}:404===t?{error:"not_found",message:"The Jira resource does not exist or is not visible."}:429===t?{error:"rate_limited",message:"Jira rate limit exceeded. Please retry later."}:t&&t>=500?{error:"server_error",message:"Jira server error. Please retry later."}:{error:"jira_error",message:b(e)}}return e instanceof Error?{error:"unknown",message:e.message}:{error:"unknown",message:"Unknown error"}}function D(e){return{content:[{type:"text",text:"string"==typeof e?e:JSON.stringify(e,null,2)}]}}const x=new s({name:"jira-mcp",version:"2.0.0"});x.registerTool("_internal_jira_set_auth",{title:"Set Jira Auth (Basic)",description:"Use when the user wants to connect Jira using Basic Auth (email + API token). This tool should only be called when the user explicitly provides credentials.",inputSchema:a.object({baseUrl:a.string(),email:a.string().email(),apiToken:a.string().min(1),persist:a.boolean().optional().default(!1)})},async({baseUrl:e,email:t,apiToken:s,persist:r})=>{const a=p(e);return await I({type:"basic",baseUrl:a,email:t,apiToken:s},r??!1),D("Jira credentials loaded (Basic Auth).")}),x.registerTool("jira_oauth_get_auth_url",{title:"Get OAuth Authorization URL",description:"Generate the OAuth 2.0 authorization URL that the user should visit to grant access. Returns the URL and required state parameter.",inputSchema:a.object({clientId:a.string().min(1).describe("OAuth Client ID from Atlassian Developer Console"),redirectUri:a.string().url().describe("Callback URL configured in your OAuth app"),scopes:a.array(a.string()).optional().default(["read:jira-work","read:jira-user","write:jira-work","offline_access"]).describe("OAuth scopes to request")})},async({clientId:e,redirectUri:t,scopes:s})=>{const r=Math.random().toString(36).substring(2,15),a=function(e,t,s,r){return`https://auth.atlassian.com/authorize?${new URLSearchParams({audience:"api.atlassian.com",i:e,scope:s.join(" "),m:t,state:r,h:"code",prompt:"consent"}).toString()}`}(e,t,s,r);return D({authUrl:a,state:r,instructions:"1. Visit the authUrl in your browser\n2. Grant access to your Jira site\n3. Copy the 'code' parameter from the redirect URL\n4. Use jira_oauth_exchange_code to exchange it for tokens"})}),x.registerTool("jira_oauth_exchange_code",{title:"Exchange OAuth Code for Tokens",description:"Exchange the authorization code for access tokens after the user has completed the OAuth flow.",inputSchema:a.object({clientId:a.string().min(1),clientSecret:a.string().min(1),code:a.string().min(1).describe("Authorization code from the OAuth callback"),redirectUri:a.string().url(),siteUrl:a.string().url().optional().describe("Optional: specific Jira site URL (e.g., https://yoursite.atlassian.net)"),persist:a.boolean().optional().default(!1)})},async({clientId:t,clientSecret:s,code:r,redirectUri:a,siteUrl:i,persist:n})=>{try{const o=await async function(t,s,r,a){const i=await e.post(c,{t:"authorization_code",i:t,o:s,code:r,m:a},{headers:{"Content-Type":"application/json"}});return{accessToken:i.data.l,refreshToken:i.data.u,expiresIn:i.data.p}}(t,s,r,a),{cloudId:u,siteName:d,siteUrl:l}=await h(o.accessToken,i),p={type:"oauth",clientId:t,clientSecret:s,accessToken:o.accessToken,refreshToken:o.refreshToken,cloudId:u,expiresAt:o.expiresIn?Date.now()+1e3*o.expiresIn:void 0};return await I(p,n),D({success:!0,message:`Successfully authenticated with OAuth to ${d}`,site:{name:d,url:l,cloudId:u},hasRefreshToken:!!o.refreshToken})}catch(e){return D(A(e))}}),x.registerTool("jira_oauth_set_tokens",{title:"Set OAuth Tokens Directly",description:"Set OAuth tokens directly if you already have them (e.g., from a previous session or external OAuth flow).",inputSchema:a.object({clientId:a.string().min(1),clientSecret:a.string().min(1),accessToken:a.string().min(1),refreshToken:a.string().optional(),cloudId:a.string().optional().describe("Cloud ID of the Jira site. If not provided, will be fetched automatically."),siteUrl:a.string().url().optional().describe("Jira site URL to find the correct cloudId"),persist:a.boolean().optional().default(!1)})},async({clientId:e,clientSecret:t,accessToken:s,refreshToken:r,cloudId:a,siteUrl:i,persist:n})=>{try{let o=a,c="",u=i||"";if(!o){const e=await h(s,i);o=e.cloudId,c=e.siteName,u=e.siteUrl}const d={type:"oauth",clientId:e,clientSecret:t,accessToken:s,refreshToken:r,cloudId:o};return await I(d,n),D({success:!0,message:c?`OAuth tokens set for ${c}`:"OAuth tokens set successfully",cloudId:o,siteUrl:u})}catch(e){return D(A(e))}}),x.registerTool("jira_oauth_refresh",{title:"Refresh OAuth Token",description:"Manually refresh the OAuth access token using the refresh token.",inputSchema:a.object({})},async()=>{try{const e=await f();if("oauth"!==e.type)return D({error:"invalid_auth_type",message:"Current authentication is not OAuth. Use basic auth credentials directly."});if(!e.refreshToken)return D({error:"no_refresh_token",message:"No refresh token available. You need to re-authenticate with 'offline_access' scope."});const t=await m(e.clientId,e.clientSecret,e.refreshToken),s={...e,accessToken:t.accessToken,refreshToken:t.refreshToken||e.refreshToken,expiresAt:Date.now()+1e3*t.expiresIn};return await I(s,!1),D({success:!0,message:"OAuth token refreshed successfully",expiresIn:t.expiresIn})}catch(e){return D(A(e))}}),x.registerTool("jira_oauth_list_sites",{title:"List Accessible Jira Sites",description:"List all Jira sites accessible with the current OAuth token.",inputSchema:a.object({})},async()=>{try{const e=await f();if("oauth"!==e.type)return D({error:"invalid_auth_type",message:"This tool requires OAuth authentication. Current auth is basic auth."});const t=await y(e.accessToken);return D({currentCloudId:e.cloudId,sites:t.map(e=>({cloudId:e.id,name:e.name,url:e.url,scopes:e.scopes}))})}catch(e){return D(A(e))}}),x.registerTool("jira_clear_auth",{title:"Clear Jira Auth",description:"Use when the user asks to remove or reset stored Jira credentials.",inputSchema:a.object({})},async()=>(await async function(){d=null;const e=await l();e&&await e.deletePassword(i,n)}(),D("Jira credentials cleared."))),x.registerTool("jira_auth_status",{title:"Get Auth Status",description:"Check the current authentication status and type.",inputSchema:a.object({})},async()=>{try{const e=await f();return"basic"===e.type?D({authenticated:!0,type:"basic",baseUrl:e.baseUrl,email:e.email}):D({authenticated:!0,type:"oauth",cloudId:e.cloudId,hasRefreshToken:!!e.refreshToken,expiresAt:e.expiresAt?new Date(e.expiresAt).toISOString():null})}catch(e){return e instanceof Error&&"MISSING_AUTH"===e.message?D({authenticated:!1,message:"No authentication configured. Use basic auth or OAuth to authenticate."}):D(A(e))}}),x.registerTool("jira_whoami",{title:"Get Jira Profile",description:"Use when the user asks who they are in Jira or wants to verify the Jira account in use."},async()=>{try{const e=w(await f());return D((await e.get("/rest/api/3/myself")).data)}catch(e){return D(A(e))}}),x.registerTool("jira_get_issue",{title:"Get Jira Issue",description:"Get the full details of a Jira issue when the user mentions an issue key like PROJ-123 or asks about a specific ticket.",inputSchema:a.object({issueIdOrKey:a.string().min(1),fields:a.array(a.string()).optional(),expand:a.string().optional()})},async({issueIdOrKey:e,fields:t,expand:s})=>{try{const r=w(await f()),a=t?.length?t:S();return D(j((await r.get(`/rest/api/3/issue/${encodeURIComponent(e)}`,{params:{fields:a.join(","),expand:s}})).data))}catch(e){return D(A(e))}}),x.registerTool("jira_search_issues",{title:"Search Jira Issues",description:"Use when the user asks to find issues matching criteria (JQL), like 'my open bugs' or 'tickets updated this week'.",inputSchema:a.object({jql:a.string().min(1),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(200).optional(),fields:a.array(a.string()).optional(),expand:a.string().optional(),nextPageToken:a.string().optional(),reconcileIssues:a.boolean().optional()})},async({jql:e,startAt:t,maxResults:s,fields:r,expand:a,nextPageToken:i,reconcileIssues:n})=>{try{const o=w(await f()),c=r?.length?r:S(),u=await o.get("/rest/api/3/search/jql",{params:{jql:e,startAt:t,maxResults:s,fields:c.join(","),expand:a,nextPageToken:i,reconcileIssues:n}}),d=Array.isArray(u.data?.issues)?u.data.issues.map(j):[];return D({total:u.data?.total??d.length,issues:d})}catch(e){return D(A(e))}}),x.registerTool("jira_search_issues_summary",{title:"Search Jira Issues (Summary)",description:"Use when the user wants the top results for a Jira search and only needs key, summary, and status.",inputSchema:a.object({jql:a.string().min(1),maxResults:a.number().int().positive().max(50).optional()})},async({jql:e,maxResults:t})=>{try{const s=w(await f()),r=await s.get("/rest/api/3/search/jql",{params:{jql:e,maxResults:t??10,fields:["summary","status"].join(",")}});return D(Array.isArray(r.data?.issues)?r.data.issues.map(v):[])}catch(e){return D(A(e))}}),x.registerTool("jira_resolve",{title:"Resolve Jira Intent",description:"Primary routing tool. Use this tool first when the user intent is clear (get issue, search, or my issues) but the exact Jira tool to call is uncertain.",inputSchema:a.object({intent:a.enum(["get_issue","search","my_issues"]),issueKey:a.string().optional(),jql:a.string().optional(),maxResults:a.number().int().positive().max(50).optional()})},async({intent:e,issueKey:t,jql:s,maxResults:r})=>{try{const a=w(await f());if("get_issue"===e){if(!t)return D({error:"invalid_input",message:"issueKey is required when intent is get_issue."});return D(j((await a.get(`/rest/api/3/issue/${encodeURIComponent(t)}`,{params:{fields:S().join(",")}})).data))}if("search"===e){if(!s)return D({error:"invalid_input",message:"jql is required when intent is search."});const e=await a.get("/rest/api/3/search/jql",{params:{jql:s,maxResults:r??10,fields:["summary","status"].join(",")}});return D(Array.isArray(e.data?.issues)?e.data.issues.map(v):[])}const i=await a.get("/rest/api/3/search/jql",{params:{jql:"assignee = currentUser() AND statusCategory != Done ORDER BY updated DESC",maxResults:r??20,fields:S().join(",")}}),n=Array.isArray(i.data?.issues)?i.data.issues.map(j):[];return D({total:i.data?.total??n.length,issues:n})}catch(e){return D(A(e))}}),x.registerTool("jira_get_issue_summary",{title:"Get Issue Summary",description:"Use when the user wants the summary, description, and acceptance criteria for a specific issue key.",inputSchema:a.object({issueIdOrKey:a.string().min(1)})},async({issueIdOrKey:e})=>{try{const t=w(await f());return D(j((await t.get(`/rest/api/3/issue/${encodeURIComponent(e)}`,{params:{fields:S().join(",")}})).data))}catch(e){return D(A(e))}}),x.registerTool("jira_get_my_open_issues",{title:"Get My Open Issues",description:"Use when the user asks for their open tickets or what they should work on next.",inputSchema:a.object({maxResults:a.number().int().positive().max(50).optional()})},async({maxResults:e})=>{try{const t=w(await f()),s=await t.get("/rest/api/3/search/jql",{params:{jql:"assignee = currentUser() AND statusCategory != Done ORDER BY updated DESC",maxResults:e??20,fields:S().join(",")}}),r=Array.isArray(s.data?.issues)?s.data.issues.map(j):[];return D({total:s.data?.total??r.length,issues:r})}catch(e){return D(A(e))}}),x.registerTool("jira_get_issue_comments",{title:"Get Issue Comments",description:"Use when the user asks for the discussion or comments on a specific ticket; returns a clean list.",inputSchema:a.object({issueIdOrKey:a.string().min(1),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(100).optional()})},async({issueIdOrKey:e,startAt:t,maxResults:s})=>{try{const r=w(await f()),a=await r.get(`/rest/api/3/issue/${encodeURIComponent(e)}/comment`,{params:{startAt:t,maxResults:s}});return D(Array.isArray(a.data?.comments)?a.data.comments.map(e=>({author:e?.author?.displayName||e?.author?.emailAddress||e?.author?.accountId||"",created:e?.created??"",body:_(e?.body)})):[])}catch(e){return D(A(e))}}),x.registerTool("jira_add_comment",{title:"Add Jira Comment",description:"Use when the user asks to add a comment to a specific ticket; confirm intent before posting.",inputSchema:a.object({issueIdOrKey:a.string().min(1),body:a.string().min(1)})},async({issueIdOrKey:e,body:t})=>{try{const s=w(await f()),r=await s.post(`/rest/api/3/issue/${encodeURIComponent(e)}/comment`,{body:k(t)});return D({id:r.data?.id??"",created:r.data?.created??""})}catch(e){return D(A(e))}}),x.registerTool("jira_add_worklog",{title:"Add Work Log",description:"Use when the user wants to log time/work on a specific Jira ticket. Allows specifying time spent, start date/time, and an optional description.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("The issue key (e.g., PROJ-123) to log work against"),timeSpent:a.string().min(1).describe("Time spent in Jira format (e.g., '1h', '30m', '1h 30m', '1d')"),started:a.string().optional().describe("When the work started in ISO 8601 format (e.g., '2026-02-13T14:00:00.000+0000'). Defaults to now if not provided."),comment:a.string().optional().describe("Optional description of the work performed")})},async({issueIdOrKey:e,timeSpent:t,started:s,comment:r})=>{try{const a=w(await f()),i={timeSpent:t};s&&(i.started=s),r&&(i.comment=k(r));const n=await a.post(`/rest/api/3/issue/${encodeURIComponent(e)}/worklog`,i);return D({id:n.data?.id??"",issueId:n.data?.issueId??"",timeSpent:n.data?.timeSpent??"",started:n.data?.started??"",author:n.data?.author?.displayName??n.data?.author?.emailAddress??"",created:n.data?.created??""})}catch(e){return D(A(e))}}),x.registerTool("jira_get_worklogs",{title:"Get Work Logs",description:"Use when the user wants to see work logs recorded on a specific Jira ticket.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("The issue key (e.g., PROJ-123) to get work logs for"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(100).optional()})},async({issueIdOrKey:e,startAt:t,maxResults:s})=>{try{const r=w(await f()),a=await r.get(`/rest/api/3/issue/${encodeURIComponent(e)}/worklog`,{params:{startAt:t,maxResults:s}}),i=Array.isArray(a.data?.worklogs)?a.data.worklogs.map(e=>({id:e?.id??"",author:e?.author?.displayName||e?.author?.emailAddress||"",timeSpent:e?.timeSpent??"",timeSpentSeconds:e?.timeSpentSeconds??0,started:e?.started??"",created:e?.created??"",comment:_(e?.comment)})):[];return D({total:a.data?.total??i.length,worklogs:i})}catch(e){return D(A(e))}}),x.registerTool("jira_list_projects",{title:"List Jira Projects",description:"Use when the user asks which Jira projects they can access or wants a list of projects.",inputSchema:a.object({startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(50).optional()})},async({startAt:e,maxResults:t})=>{try{const s=w(await f());return D((await s.get("/rest/api/3/project/search",{params:{startAt:e,maxResults:t}})).data)}catch(e){return D(A(e))}}),x.registerTool("jira_get_project",{title:"Get Jira Project",description:"Use when the user mentions a project key and asks for project details or metadata.",inputSchema:a.object({projectIdOrKey:a.string().min(1)})},async({projectIdOrKey:e})=>{try{const t=w(await f());return D((await t.get(`/rest/api/3/project/${encodeURIComponent(e)}`)).data)}catch(e){return D(A(e))}}),x.registerTool("jira_create_issue",{title:"Create Jira Issue",description:"Create a new Jira issue. Requires project key, issue type, and summary at minimum.",inputSchema:a.object({projectKey:a.string().min(1).describe("Project key (e.g., 'MXTS')"),issueType:a.string().min(1).describe("Issue type name or ID (e.g., 'Bug', 'Task', 'Story')"),summary:a.string().min(1).describe("Issue title/summary"),description:a.string().optional().describe("Issue description (plain text, will be converted to ADF)"),assignee:a.string().optional().describe("Assignee account ID. Use '-1' for automatic assignment."),reporter:a.string().optional().describe("Reporter account ID"),priority:a.string().optional().describe("Priority name or ID (e.g., 'High', 'Medium', 'Low')"),labels:a.array(a.string()).optional().describe("Array of label strings"),components:a.array(a.string()).optional().describe("Array of component names or IDs"),fixVersions:a.array(a.string()).optional().describe("Array of fix version names or IDs"),affectsVersions:a.array(a.string()).optional().describe("Array of affected version names or IDs"),dueDate:a.string().optional().describe("Due date in YYYY-MM-DD format"),parentKey:a.string().optional().describe("Parent issue key for subtasks"),environment:a.string().optional().describe("Environment description"),originalEstimate:a.string().optional().describe("Original time estimate (e.g., '2h', '1d')"),customFields:a.record(a.string(),a.unknown()).optional().describe("Custom field values as key-value pairs")})},async e=>{try{const t=w(await f()),s=function(e){const t={};if(e.projectKey&&(t.project={key:e.projectKey}),e.issueType&&(t.issuetype=/^\d+$/.test(e.issueType)?{id:e.issueType}:{name:e.issueType}),void 0!==e.summary&&(t.summary=e.summary),void 0!==e.description&&(t.description=e.description?k(e.description):null),void 0!==e.assignee&&(t.assignee=null===e.assignee?null:{accountId:e.assignee}),e.reporter&&(t.reporter={accountId:e.reporter}),e.priority&&(t.priority=/^\d+$/.test(e.priority)?{id:e.priority}:{name:e.priority}),e.labels&&e.labels.length>0&&(t.labels=e.labels),e.components&&e.components.length>0&&(t.components=e.components.map(e=>/^\d+$/.test(e)?{id:e}:{name:e})),e.fixVersions&&e.fixVersions.length>0&&(t.fixVersions=e.fixVersions.map(e=>/^\d+$/.test(e)?{id:e}:{name:e})),e.affectsVersions&&e.affectsVersions.length>0&&(t.versions=e.affectsVersions.map(e=>/^\d+$/.test(e)?{id:e}:{name:e})),void 0!==e.dueDate&&(t.duedate=e.dueDate),e.parentKey&&(t.parent={key:e.parentKey}),e.environment&&(t.environment=k(e.environment)),(e.originalEstimate||e.remainingEstimate)&&(t.timetracking={},e.originalEstimate&&(t.timetracking.originalEstimate=e.originalEstimate),e.remainingEstimate&&(t.timetracking.remainingEstimate=e.remainingEstimate)),e.customFields)for(const[s,r]of Object.entries(e.customFields)){const e=s.startsWith("customfield_")?s:`customfield_${s}`;"string"==typeof r&&r.length,t[e]=r}return t}({projectKey:e.projectKey,issueType:e.issueType,summary:e.summary,description:e.description,assignee:e.assignee,reporter:e.reporter,priority:e.priority,labels:e.labels,components:e.components,fixVersions:e.fixVersions,affectsVersions:e.affectsVersions,dueDate:e.dueDate,parentKey:e.parentKey,environment:e.environment,originalEstimate:e.originalEstimate,customFields:e.customFields}),r=await t.post("/rest/api/3/issue",{fields:s});return D({success:!0,id:r.data?.id??"",key:r.data?.key??"",self:r.data?.self??"",message:`Issue ${r.data?.key} created successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_update_issue",{title:"Update Jira Issue",description:"Update an existing Jira issue. Only provided fields will be modified.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID (e.g., 'MXTS-123')"),summary:a.string().optional().describe("New summary/title"),description:a.string().optional().describe("New description (plain text)"),assignee:a.string().nullable().optional().describe("Assignee account ID. Use null to unassign."),priority:a.string().optional().describe("Priority name or ID"),dueDate:a.string().nullable().optional().describe("Due date (YYYY-MM-DD) or null to clear"),labels:a.object({add:a.array(a.string()).optional(),remove:a.array(a.string()).optional(),set:a.array(a.string()).optional()}).optional().describe("Label operations: add, remove, or set"),components:a.object({add:a.array(a.string()).optional(),remove:a.array(a.string()).optional(),set:a.array(a.string()).optional()}).optional().describe("Component operations: add, remove, or set"),fixVersions:a.object({add:a.array(a.string()).optional(),remove:a.array(a.string()).optional(),set:a.array(a.string()).optional()}).optional().describe("Fix version operations: add, remove, or set"),customFields:a.record(a.string(),a.unknown()).optional().describe("Custom field values"),notifyUsers:a.boolean().optional().default(!0).describe("Send notifications to watchers")})},async e=>{try{const t=w(await f()),s={},r={};if(void 0!==e.summary&&(r.summary=e.summary),void 0!==e.description&&(r.description=e.description?k(e.description):null),void 0!==e.assignee&&(r.assignee=null===e.assignee?null:{accountId:e.assignee}),void 0!==e.priority&&(r.priority=/^\d+$/.test(e.priority)?{id:e.priority}:{name:e.priority}),void 0!==e.dueDate&&(r.duedate=e.dueDate),e.customFields)for(const[t,s]of Object.entries(e.customFields)){r[t.startsWith("customfield_")?t:`customfield_${t}`]=s}Object.keys(r).length>0&&(s.fields=r);const a=function(e){const t={};if(e.labels){const s=[];e.labels.add&&e.labels.add.forEach(e=>s.push({add:e})),e.labels.remove&&e.labels.remove.forEach(e=>s.push({remove:e})),e.labels.set&&s.push({set:e.labels.set}),t.labels=s}if(e.components){const s=[];e.components.add&&e.components.add.forEach(e=>s.push({add:/^\d+$/.test(e)?{id:e}:{name:e}})),e.components.remove&&e.components.remove.forEach(e=>s.push({remove:/^\d+$/.test(e)?{id:e}:{name:e}})),e.components.set&&s.push({set:e.components.set.map(e=>/^\d+$/.test(e)?{id:e}:{name:e})}),t.components=s}if(e.fixVersions){const s=[];e.fixVersions.add&&e.fixVersions.add.forEach(e=>s.push({add:/^\d+$/.test(e)?{id:e}:{name:e}})),e.fixVersions.remove&&e.fixVersions.remove.forEach(e=>s.push({remove:/^\d+$/.test(e)?{id:e}:{name:e}})),e.fixVersions.set&&s.push({set:e.fixVersions.set.map(e=>/^\d+$/.test(e)?{id:e}:{name:e})}),t.fixVersions=s}if(e.affectsVersions){const s=[];e.affectsVersions.add&&e.affectsVersions.add.forEach(e=>s.push({add:/^\d+$/.test(e)?{id:e}:{name:e}})),e.affectsVersions.remove&&e.affectsVersions.remove.forEach(e=>s.push({remove:/^\d+$/.test(e)?{id:e}:{name:e}})),e.affectsVersions.set&&s.push({set:e.affectsVersions.set.map(e=>/^\d+$/.test(e)?{id:e}:{name:e})}),t.versions=s}return t}({labels:e.labels,components:e.components,fixVersions:e.fixVersions});return Object.keys(a).length>0&&(s.update=a),0===Object.keys(s).length?D({error:"no_changes",message:"No fields provided to update"}):(await t.put(`/rest/api/3/issue/${encodeURIComponent(e.issueIdOrKey)}`,s,{params:{notifyUsers:e.notifyUsers??!0}}),D({success:!0,key:e.issueIdOrKey,message:`Issue ${e.issueIdOrKey} updated successfully`}))}catch(e){return D(A(e))}}),x.registerTool("jira_delete_issue",{title:"Delete Jira Issue",description:"Delete a Jira issue. Requires explicit confirmation. Use with caution - this action cannot be undone.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID to delete"),deleteSubtasks:a.boolean().optional().default(!1).describe("Also delete subtasks"),confirmDelete:a.boolean().describe("Must be true to confirm deletion")})},async({issueIdOrKey:e,deleteSubtasks:t,confirmDelete:s})=>{try{if(!s)return D({error:"confirmation_required",message:"Deletion not confirmed. Set confirmDelete: true to proceed. This action cannot be undone.",issueKey:e});const r=w(await f());return await r.delete(`/rest/api/3/issue/${encodeURIComponent(e)}`,{params:{deleteSubtasks:t??!1}}),D({success:!0,message:`Issue ${e} deleted successfully${t?" (including subtasks)":""}`})}catch(e){return D(A(e))}}),x.registerTool("jira_assign_issue",{title:"Assign Jira Issue",description:"Assign or unassign a Jira issue to a user.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID"),accountId:a.string().nullable().describe("User account ID to assign, '-1' for automatic, or null to unassign")})},async({issueIdOrKey:e,accountId:t})=>{try{const s=w(await f());await s.put(`/rest/api/3/issue/${encodeURIComponent(e)}/assignee`,{accountId:t});return D({success:!0,key:e,message:`Issue ${e} ${null===t?"unassigned":"assigned"} successfully`,assignee:t})}catch(e){return D(A(e))}}),x.registerTool("jira_get_transitions",{title:"Get Issue Transitions",description:"Get available workflow transitions for an issue. Use before transitioning to see valid options.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID"),expand:a.string().optional().describe("Expand options: 'transitions.fields' to include required fields")})},async({issueIdOrKey:e,expand:t})=>{try{const s=w(await f()),r=await s.get(`/rest/api/3/issue/${encodeURIComponent(e)}/transitions`,{params:{expand:t}});return D({issueKey:e,transitions:Array.isArray(r.data?.transitions)?r.data.transitions.map(e=>({id:e.id,name:e.name,to:{id:e.to?.id,name:e.to?.name,statusCategory:e.to?.statusCategory?.name},hasScreen:e.hasScreen??!1,isGlobal:e.isGlobal??!1,isInitial:e.isInitial??!1,isConditional:e.isConditional??!1,fields:e.fields?Object.keys(e.fields):[]})):[]})}catch(e){return D(A(e))}}),x.registerTool("jira_transition_issue",{title:"Transition Jira Issue",description:"Move a Jira issue to a different status by executing a workflow transition.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID"),transitionId:a.string().min(1).describe("Transition ID (get from jira_get_transitions)"),comment:a.string().optional().describe("Comment to add during transition"),resolution:a.string().optional().describe("Resolution name for closing transitions (e.g., 'Done', 'Fixed')"),fields:a.record(a.string(),a.unknown()).optional().describe("Additional fields required by the transition")})},async({issueIdOrKey:e,transitionId:t,comment:s,resolution:r,fields:a})=>{try{const i=w(await f()),n={transition:{id:t}};if(a||r){const e={...a};r&&(e.resolution={name:r}),n.fields=e}return s&&(n.update={comment:[{add:{body:k(s)}}]}),await i.post(`/rest/api/3/issue/${encodeURIComponent(e)}/transitions`,n),D({success:!0,key:e,transitionId:t,message:`Issue ${e} transitioned successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_issue_types",{title:"Get Issue Types",description:"Get available issue types, optionally filtered by project.",inputSchema:a.object({projectKey:a.string().optional().describe("Filter issue types for a specific project")})},async({projectKey:e})=>{try{const t=w(await f());let s;if(e){const r=await t.get(`/rest/api/3/project/${encodeURIComponent(e)}`);s=r.data?.issueTypes||[]}else{s=(await t.get("/rest/api/3/issuetype")).data||[]}return D(s.map(e=>({id:e.id,name:e.name,description:e.description||"",subtask:e.subtask??!1,hierarchyLevel:e.hierarchyLevel})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_priorities",{title:"Get Priorities",description:"Get available priority levels for issues.",inputSchema:a.object({})},async()=>{try{const e=w(await f());return D(((await e.get("/rest/api/3/priority")).data||[]).map(e=>({id:e.id,name:e.name,description:e.description||"",iconUrl:e.iconUrl})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_statuses",{title:"Get Statuses",description:"Get available statuses, optionally filtered by project.",inputSchema:a.object({projectKey:a.string().optional().describe("Filter statuses for a specific project")})},async({projectKey:e})=>{try{const t=w(await f());if(e){return D((await t.get(`/rest/api/3/project/${encodeURIComponent(e)}/statuses`)).data||[])}return D(((await t.get("/rest/api/3/status")).data||[]).map(e=>({id:e.id,name:e.name,description:e.description||"",statusCategory:e.statusCategory?.name})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_components",{title:"Get Project Components",description:"Get components for a specific project.",inputSchema:a.object({projectKey:a.string().min(1).describe("Project key")})},async({projectKey:e})=>{try{const t=w(await f());return D(((await t.get(`/rest/api/3/project/${encodeURIComponent(e)}/components`)).data||[]).map(e=>({id:e.id,name:e.name,description:e.description||"",lead:e.lead?.displayName,assigneeType:e.assigneeType})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_versions",{title:"Get Project Versions",description:"Get versions for a specific project.",inputSchema:a.object({projectKey:a.string().min(1).describe("Project key"),released:a.boolean().optional().describe("Filter by released status")})},async({projectKey:e,released:t})=>{try{const s=w(await f());let r=(await s.get(`/rest/api/3/project/${encodeURIComponent(e)}/versions`)).data||[];return void 0!==t&&(r=r.filter(e=>e.released===t)),D(r.map(e=>({id:e.id,name:e.name,description:e.description||"",released:e.released??!1,archived:e.archived??!1,releaseDate:e.releaseDate,startDate:e.startDate})))}catch(e){return D(A(e))}}),x.registerTool("jira_search_users",{title:"Search Jira Users",description:"Search for Jira users by name, email, or username.",inputSchema:a.object({query:a.string().min(1).describe("Search query (name, email, or username)"),projectKey:a.string().optional().describe("Filter users with access to this project"),maxResults:a.number().int().positive().max(50).optional().default(10)})},async({query:e,projectKey:t,maxResults:s})=>{try{const r=w(await f());let a=(await r.get("/rest/api/3/user/search",{params:{query:e,maxResults:s??10}})).data||[];if(t&&a.length>0)try{a=(await r.get("/rest/api/3/user/assignable/search",{params:{query:e,project:t,maxResults:s??10}})).data||[]}catch{}return D(a.map(e=>({accountId:e.accountId,displayName:e.displayName,emailAddress:e.emailAddress,active:e.active??!0,avatarUrl:e.avatarUrls?.["48x48"]})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_changelog",{title:"Get Issue Changelog",description:"Get the history of changes for an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(100).optional().default(20)})},async({issueIdOrKey:e,startAt:t,maxResults:s})=>{try{const r=w(await f()),a=await r.get(`/rest/api/3/issue/${encodeURIComponent(e)}/changelog`,{params:{startAt:t,maxResults:s??20}}),i=Array.isArray(a.data?.values)?a.data.values.map(e=>({id:e.id,author:e.author?.displayName||e.author?.emailAddress||"",created:e.created,items:(e.items||[]).map(e=>({field:e.field,fieldtype:e.fieldtype,from:e.fromString||e.from,to:e.toString||e.to}))})):[];return D({total:a.data?.total??i.length,startAt:a.data?.startAt??0,changes:i})}catch(e){return D(A(e))}}),x.registerTool("jira_get_boards",{title:"Get Jira Boards",description:"Get all Scrum and Kanban boards, optionally filtered by project or type.",inputSchema:a.object({projectKeyOrId:a.string().optional().describe("Filter boards by project"),type:a.enum(["scrum","kanban","simple"]).optional().describe("Filter by board type"),name:a.string().optional().describe("Filter boards by name (contains)"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(50).optional().default(50)})},async({projectKeyOrId:e,type:t,name:s,startAt:r,maxResults:a})=>{try{const i=w(await f()),n=await i.get("/rest/agile/1.0/board",{params:{projectKeyOrId:e,type:t,name:s,startAt:r,maxResults:a??50}}),o=Array.isArray(n.data?.values)?n.data.values.map(e=>({id:e.id,name:e.name,type:e.type,projectKey:e.location?.projectKey,projectName:e.location?.displayName})):[];return D({total:n.data?.total??o.length,startAt:n.data?.startAt??0,boards:o})}catch(e){return D(A(e))}}),x.registerTool("jira_get_board",{title:"Get Board Details",description:"Get details of a specific board including configuration.",inputSchema:a.object({boardId:a.number().int().positive().describe("Board ID")})},async({boardId:e})=>{try{const t=w(await f()),s=await t.get(`/rest/agile/1.0/board/${e}`);return D({id:s.data?.id,name:s.data?.name,type:s.data?.type,self:s.data?.self,location:s.data?.location})}catch(e){return D(A(e))}}),x.registerTool("jira_get_board_configuration",{title:"Get Board Configuration",description:"Get the configuration of a board including columns, estimation, and ranking.",inputSchema:a.object({boardId:a.number().int().positive().describe("Board ID")})},async({boardId:e})=>{try{const t=w(await f()),s=await t.get(`/rest/agile/1.0/board/${e}/configuration`);return D({id:s.data?.id,name:s.data?.name,type:s.data?.type,filter:s.data?.filter,columnConfig:s.data?.columnConfig,estimation:s.data?.estimation,ranking:s.data?.ranking})}catch(e){return D(A(e))}}),x.registerTool("jira_get_sprints",{title:"Get Sprints",description:"Get sprints for a board, optionally filtered by state.",inputSchema:a.object({boardId:a.number().int().positive().describe("Board ID"),state:a.enum(["future","active","closed"]).optional().describe("Filter by sprint state"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(50).optional().default(50)})},async({boardId:e,state:t,startAt:s,maxResults:r})=>{try{const a=w(await f()),i=await a.get(`/rest/agile/1.0/board/${e}/sprint`,{params:{state:t,startAt:s,maxResults:r??50}}),n=Array.isArray(i.data?.values)?i.data.values.map(e=>({id:e.id,name:e.name,state:e.state,startDate:e.startDate,endDate:e.endDate,completeDate:e.completeDate,originBoardId:e.originBoardId,goal:e.goal})):[];return D({total:i.data?.total??n.length,startAt:i.data?.startAt??0,sprints:n})}catch(e){return D(A(e))}}),x.registerTool("jira_get_sprint",{title:"Get Sprint Details",description:"Get details of a specific sprint.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Sprint ID")})},async({sprintId:e})=>{try{const t=w(await f()),s=await t.get(`/rest/agile/1.0/sprint/${e}`);return D({id:s.data?.id,name:s.data?.name,state:s.data?.state,startDate:s.data?.startDate,endDate:s.data?.endDate,completeDate:s.data?.completeDate,originBoardId:s.data?.originBoardId,goal:s.data?.goal})}catch(e){return D(A(e))}}),x.registerTool("jira_create_sprint",{title:"Create Sprint",description:"Create a new sprint on a board.",inputSchema:a.object({boardId:a.number().int().positive().describe("Board ID"),name:a.string().min(1).describe("Sprint name"),startDate:a.string().optional().describe("Start date (ISO 8601)"),endDate:a.string().optional().describe("End date (ISO 8601)"),goal:a.string().optional().describe("Sprint goal")})},async({boardId:e,name:t,startDate:s,endDate:r,goal:a})=>{try{const i=w(await f()),n=await i.post("/rest/agile/1.0/sprint",{originBoardId:e,name:t,startDate:s,endDate:r,goal:a});return D({success:!0,id:n.data?.id,name:n.data?.name,state:n.data?.state,message:`Sprint "${t}" created successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_update_sprint",{title:"Update Sprint",description:"Update sprint details including name, dates, and goal.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Sprint ID"),name:a.string().optional().describe("New sprint name"),state:a.enum(["future","active","closed"]).optional().describe("Sprint state"),startDate:a.string().optional().describe("Start date (ISO 8601)"),endDate:a.string().optional().describe("End date (ISO 8601)"),goal:a.string().optional().describe("Sprint goal")})},async({sprintId:e,name:t,state:s,startDate:r,endDate:a,goal:i})=>{try{const n=w(await f()),o={};if(void 0!==t&&(o.name=t),void 0!==s&&(o.state=s),void 0!==r&&(o.startDate=r),void 0!==a&&(o.endDate=a),void 0!==i&&(o.goal=i),0===Object.keys(o).length)return D({error:"no_changes",message:"No fields provided to update"});const c=await n.put(`/rest/agile/1.0/sprint/${e}`,o);return D({success:!0,id:c.data?.id??e,name:c.data?.name,state:c.data?.state,message:"Sprint updated successfully"})}catch(e){return D(A(e))}}),x.registerTool("jira_start_sprint",{title:"Start Sprint",description:"Start a sprint that is in 'future' state.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Sprint ID"),startDate:a.string().optional().describe("Start date (defaults to now)"),endDate:a.string().describe("End date (required for starting a sprint)")})},async({sprintId:e,startDate:t,endDate:s})=>{try{const r=w(await f()),a=await r.post(`/rest/agile/1.0/sprint/${e}`,{state:"active",startDate:t||(new Date).toISOString(),endDate:s});return D({success:!0,id:a.data?.id??e,state:"active",message:"Sprint started successfully"})}catch(e){return D(A(e))}}),x.registerTool("jira_complete_sprint",{title:"Complete Sprint",description:"Complete an active sprint. Optionally move incomplete issues to another sprint or backlog.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Sprint ID to complete"),moveIncompleteIssuesTo:a.number().int().positive().optional().describe("Sprint ID to move incomplete issues to (omit to move to backlog)")})},async({sprintId:e,moveIncompleteIssuesTo:t})=>{try{const s=w(await f());return await s.post(`/rest/agile/1.0/sprint/${e}`,{state:"closed"}),D({success:!0,id:e,state:"closed",message:"Sprint completed successfully",incompleteIssuesMovedTo:t||"backlog"})}catch(e){return D(A(e))}}),x.registerTool("jira_delete_sprint",{title:"Delete Sprint",description:"Delete a sprint. Use with caution - cannot be undone.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Sprint ID to delete"),confirmDelete:a.boolean().describe("Must be true to confirm deletion")})},async({sprintId:e,confirmDelete:t})=>{try{if(!t)return D({error:"confirmation_required",message:"Deletion not confirmed. Set confirmDelete: true to proceed.",sprintId:e});const s=w(await f());return await s.delete(`/rest/agile/1.0/sprint/${e}`),D({success:!0,message:`Sprint ${e} deleted successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_sprint_issues",{title:"Get Sprint Issues",description:"Get all issues in a sprint.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Sprint ID"),jql:a.string().optional().describe("Additional JQL filter"),fields:a.array(a.string()).optional().describe("Fields to return"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(100).optional().default(50)})},async({sprintId:e,jql:t,fields:s,startAt:r,maxResults:a})=>{try{const i=w(await f()),n=await i.get(`/rest/agile/1.0/sprint/${e}/issue`,{params:{jql:t,fields:s?.join(","),startAt:r,maxResults:a??50}}),o=Array.isArray(n.data?.issues)?n.data.issues.map(e=>({key:e.key,summary:e.fields?.summary,status:e.fields?.status?.name,assignee:e.fields?.assignee?.displayName,issueType:e.fields?.issuetype?.name,priority:e.fields?.priority?.name,storyPoints:e.fields?.I})):[];return D({total:n.data?.total??o.length,startAt:n.data?.startAt??0,sprintId:e,issues:o})}catch(e){return D(A(e))}}),x.registerTool("jira_move_issues_to_sprint",{title:"Move Issues to Sprint",description:"Move issues to a sprint.",inputSchema:a.object({sprintId:a.number().int().positive().describe("Target sprint ID"),issueKeys:a.array(a.string().min(1)).min(1).describe("Issue keys to move")})},async({sprintId:e,issueKeys:t})=>{try{const s=w(await f());return await s.post(`/rest/agile/1.0/sprint/${e}/issue`,{issues:t}),D({success:!0,sprintId:e,issuesMoved:t,message:`${t.length} issue(s) moved to sprint ${e}`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_backlog_issues",{title:"Get Backlog Issues",description:"Get issues in the backlog (not in any active sprint) for a board.",inputSchema:a.object({boardId:a.number().int().positive().describe("Board ID"),jql:a.string().optional().describe("Additional JQL filter"),fields:a.array(a.string()).optional().describe("Fields to return"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(100).optional().default(50)})},async({boardId:e,jql:t,fields:s,startAt:r,maxResults:a})=>{try{const i=w(await f()),n=await i.get(`/rest/agile/1.0/board/${e}/backlog`,{params:{jql:t,fields:s?.join(","),startAt:r,maxResults:a??50}}),o=Array.isArray(n.data?.issues)?n.data.issues.map(e=>({key:e.key,summary:e.fields?.summary,status:e.fields?.status?.name,assignee:e.fields?.assignee?.displayName,issueType:e.fields?.issuetype?.name,priority:e.fields?.priority?.name})):[];return D({total:n.data?.total??o.length,startAt:n.data?.startAt??0,boardId:e,issues:o})}catch(e){return D(A(e))}}),x.registerTool("jira_move_issues_to_backlog",{title:"Move Issues to Backlog",description:"Move issues from a sprint back to the backlog.",inputSchema:a.object({issueKeys:a.array(a.string().min(1)).min(1).describe("Issue keys to move to backlog")})},async({issueKeys:e})=>{try{const t=w(await f());return await t.post("/rest/agile/1.0/backlog/issue",{issues:e}),D({success:!0,issuesMoved:e,message:`${e.length} issue(s) moved to backlog`})}catch(e){return D(A(e))}}),x.registerTool("jira_rank_issues",{title:"Rank Issues",description:"Change the rank of issues on a board by placing them before or after another issue.",inputSchema:a.object({issueKeys:a.array(a.string().min(1)).min(1).describe("Issue keys to rank"),rankBeforeIssue:a.string().optional().describe("Issue key to rank before"),rankAfterIssue:a.string().optional().describe("Issue key to rank after")})},async({issueKeys:e,rankBeforeIssue:t,rankAfterIssue:s})=>{try{if(!t&&!s)return D({error:"invalid_parameters",message:"Either rankBeforeIssue or rankAfterIssue must be provided"});const r=w(await f()),a={issues:e};return t?a.rankBeforeIssue=t:s&&(a.rankAfterIssue=s),await r.put("/rest/agile/1.0/issue/rank",a),D({success:!0,issuesRanked:e,message:`${e.length} issue(s) ranked successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_issue_links",{title:"Get Issue Links",description:"Get all linked issues for a specific issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f()),s=await t.get(`/rest/api/3/issue/${encodeURIComponent(e)}`,{params:{fields:"issuelinks"}});return D({issueKey:e,links:Array.isArray(s.data?.fields?.issuelinks)?s.data.fields.issuelinks.map(e=>{const t=!!e.inwardIssue,s=t?e.inwardIssue:e.outwardIssue;return{id:e.id,type:e.type?.name,direction:t?"inward":"outward",description:t?e.type?.inward:e.type?.outward,linkedIssue:{key:s?.key,summary:s?.fields?.summary,status:s?.fields?.status?.name,issueType:s?.fields?.issuetype?.name}}}):[]})}catch(e){return D(A(e))}}),x.registerTool("jira_create_issue_link",{title:"Link Issues",description:"Create a link between two issues.",inputSchema:a.object({inwardIssue:a.string().min(1).describe("Inward issue key (the 'from' issue)"),outwardIssue:a.string().min(1).describe("Outward issue key (the 'to' issue)"),linkType:a.string().min(1).describe("Link type name (e.g., 'Blocks', 'Relates', 'Duplicates')"),comment:a.string().optional().describe("Comment to add with the link")})},async({inwardIssue:e,outwardIssue:t,linkType:s,comment:r})=>{try{const a=w(await f()),i={type:{name:s},inwardIssue:{key:e},outwardIssue:{key:t}};return r&&(i.comment={body:k(r)}),await a.post("/rest/api/3/issueLink",i),D({success:!0,message:`Link created: ${e} ${s} ${t}`,inwardIssue:e,outwardIssue:t,linkType:s})}catch(e){return D(A(e))}}),x.registerTool("jira_delete_issue_link",{title:"Delete Issue Link",description:"Remove a link between issues.",inputSchema:a.object({linkId:a.string().min(1).describe("Link ID to delete (get from jira_get_issue_links)")})},async({linkId:e})=>{try{const t=w(await f());return await t.delete(`/rest/api/3/issueLink/${e}`),D({success:!0,message:`Link ${e} deleted successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_link_types",{title:"Get Issue Link Types",description:"Get available link types for linking issues.",inputSchema:a.object({})},async()=>{try{const e=w(await f()),t=await e.get("/rest/api/3/issueLinkType");return D((t.data?.issueLinkTypes||[]).map(e=>({id:e.id,name:e.name,inward:e.inward,outward:e.outward})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_watchers",{title:"Get Issue Watchers",description:"Get the list of users watching an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f()),s=await t.get(`/rest/api/3/issue/${encodeURIComponent(e)}/watchers`),r=Array.isArray(s.data?.watchers)?s.data.watchers.map(e=>({accountId:e.accountId,displayName:e.displayName,emailAddress:e.emailAddress})):[];return D({issueKey:e,watchCount:s.data?.watchCount??r.length,isWatching:s.data?.isWatching??!1,watchers:r})}catch(e){return D(A(e))}}),x.registerTool("jira_add_watcher",{title:"Add Issue Watcher",description:"Add a user to watch an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID"),accountId:a.string().min(1).describe("User account ID to add as watcher")})},async({issueIdOrKey:e,accountId:t})=>{try{const s=w(await f());return await s.post(`/rest/api/3/issue/${encodeURIComponent(e)}/watchers`,JSON.stringify(t),{headers:{"Content-Type":"application/json"}}),D({success:!0,issueKey:e,accountId:t,message:"User added as watcher"})}catch(e){return D(A(e))}}),x.registerTool("jira_remove_watcher",{title:"Remove Issue Watcher",description:"Remove a user from watching an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID"),accountId:a.string().min(1).describe("User account ID to remove")})},async({issueIdOrKey:e,accountId:t})=>{try{const s=w(await f());return await s.delete(`/rest/api/3/issue/${encodeURIComponent(e)}/watchers`,{params:{accountId:t}}),D({success:!0,issueKey:e,accountId:t,message:"User removed from watchers"})}catch(e){return D(A(e))}}),x.registerTool("jira_get_votes",{title:"Get Issue Votes",description:"Get the vote count and voters for an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f()),s=await t.get(`/rest/api/3/issue/${encodeURIComponent(e)}/votes`),r=Array.isArray(s.data?.voters)?s.data.voters.map(e=>({accountId:e.accountId,displayName:e.displayName})):[];return D({issueKey:e,votes:s.data?.votes??0,hasVoted:s.data?.hasVoted??!1,voters:r})}catch(e){return D(A(e))}}),x.registerTool("jira_add_vote",{title:"Vote for Issue",description:"Add your vote to an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f());return await t.post(`/rest/api/3/issue/${encodeURIComponent(e)}/votes`),D({success:!0,issueKey:e,message:"Vote added successfully"})}catch(e){return D(A(e))}}),x.registerTool("jira_remove_vote",{title:"Remove Vote",description:"Remove your vote from an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f());return await t.delete(`/rest/api/3/issue/${encodeURIComponent(e)}/votes`),D({success:!0,issueKey:e,message:"Vote removed successfully"})}catch(e){return D(A(e))}}),x.registerTool("jira_get_attachments",{title:"Get Issue Attachments",description:"Get all attachments for an issue.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f()),s=await t.get(`/rest/api/3/issue/${encodeURIComponent(e)}`,{params:{fields:"attachment"}});return D({issueKey:e,attachments:Array.isArray(s.data?.fields?.attachment)?s.data.fields.attachment.map(e=>({id:e.id,filename:e.filename,size:e.size,mimeType:e.mimeType,content:e.content,thumbnail:e.thumbnail,author:e.author?.displayName,created:e.created})):[]})}catch(e){return D(A(e))}}),x.registerTool("jira_delete_attachment",{title:"Delete Attachment",description:"Delete an attachment from an issue.",inputSchema:a.object({attachmentId:a.string().min(1).describe("Attachment ID to delete")})},async({attachmentId:e})=>{try{const t=w(await f());return await t.delete(`/rest/api/3/attachment/${e}`),D({success:!0,message:`Attachment ${e} deleted successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_epics",{title:"Get Epics",description:"Get epics for a board.",inputSchema:a.object({boardId:a.number().int().positive().describe("Board ID"),done:a.enum(["true","false"]).optional().describe("Filter by completion status"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(50).optional().default(50)})},async({boardId:e,done:t,startAt:s,maxResults:r})=>{try{const a=w(await f()),i=await a.get(`/rest/agile/1.0/board/${e}/epic`,{params:{done:t,startAt:s,maxResults:r??50}}),n=Array.isArray(i.data?.values)?i.data.values.map(e=>({id:e.id,key:e.key,name:e.name,summary:e.summary,done:e.done??!1})):[];return D({total:i.data?.total??n.length,startAt:i.data?.startAt??0,boardId:e,epics:n})}catch(e){return D(A(e))}}),x.registerTool("jira_get_epic_issues",{title:"Get Epic Issues",description:"Get all issues belonging to an epic.",inputSchema:a.object({epicIdOrKey:a.string().min(1).describe("Epic ID or key"),jql:a.string().optional().describe("Additional JQL filter"),fields:a.array(a.string()).optional().describe("Fields to return"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(100).optional().default(50)})},async({epicIdOrKey:e,jql:t,fields:s,startAt:r,maxResults:a})=>{try{const i=w(await f()),n=await i.get(`/rest/agile/1.0/epic/${e}/issue`,{params:{jql:t,fields:s?.join(","),startAt:r,maxResults:a??50}}),o=Array.isArray(n.data?.issues)?n.data.issues.map(e=>({key:e.key,summary:e.fields?.summary,status:e.fields?.status?.name,assignee:e.fields?.assignee?.displayName,issueType:e.fields?.issuetype?.name})):[];return D({total:n.data?.total??o.length,startAt:n.data?.startAt??0,epicKey:e,issues:o})}catch(e){return D(A(e))}}),x.registerTool("jira_move_issues_to_epic",{title:"Move Issues to Epic",description:"Move issues to an epic.",inputSchema:a.object({epicIdOrKey:a.string().min(1).describe("Epic ID or key"),issueKeys:a.array(a.string().min(1)).min(1).describe("Issue keys to move")})},async({epicIdOrKey:e,issueKeys:t})=>{try{const s=w(await f());return await s.post(`/rest/agile/1.0/epic/${e}/issue`,{issues:t}),D({success:!0,epicKey:e,issuesMoved:t,message:`${t.length} issue(s) moved to epic ${e}`})}catch(e){return D(A(e))}}),x.registerTool("jira_remove_issues_from_epic",{title:"Remove Issues from Epic",description:"Remove issues from their epic (move to no epic).",inputSchema:a.object({issueKeys:a.array(a.string().min(1)).min(1).describe("Issue keys to remove from epic")})},async({issueKeys:e})=>{try{const t=w(await f());return await t.post("/rest/agile/1.0/epic/none/issue",{issues:e}),D({success:!0,issuesRemoved:e,message:`${e.length} issue(s) removed from epic`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_fields",{title:"Get All Fields",description:"Get all available fields including custom fields.",inputSchema:a.object({})},async()=>{try{const e=w(await f());return D(((await e.get("/rest/api/3/field")).data||[]).map(e=>({id:e.id,key:e.key,name:e.name,custom:e.custom??!1,orderable:e.orderable??!1,navigable:e.navigable??!1,searchable:e.searchable??!1,clauseNames:e.clauseNames||[],schema:e.schema})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_create_metadata",{title:"Get Create Issue Metadata",description:"Get metadata for creating issues in a project, including required fields.",inputSchema:a.object({projectKeys:a.array(a.string()).optional().describe("Project keys to get metadata for"),projectIds:a.array(a.string()).optional().describe("Project IDs to get metadata for"),issuetypeNames:a.array(a.string()).optional().describe("Issue type names to filter"),expand:a.string().optional().describe("Expand options")})},async({projectKeys:e,projectIds:t,issuetypeNames:s,expand:r})=>{try{const a=w(await f());return D((await a.get("/rest/api/3/issue/createmeta",{params:{projectKeys:e?.join(","),projectIds:t?.join(","),issuetypeNames:s?.join(","),expand:r||"projects.issuetypes.fields"}})).data)}catch(e){return D(A(e))}}),x.registerTool("jira_get_edit_metadata",{title:"Get Edit Issue Metadata",description:"Get metadata for editing a specific issue, including editable fields.",inputSchema:a.object({issueIdOrKey:a.string().min(1).describe("Issue key or ID")})},async({issueIdOrKey:e})=>{try{const t=w(await f());return D((await t.get(`/rest/api/3/issue/${encodeURIComponent(e)}/editmeta`)).data)}catch(e){return D(A(e))}}),x.registerTool("jira_get_filters",{title:"Get Filters",description:"Get saved filters, optionally filtered by name.",inputSchema:a.object({filterName:a.string().optional().describe("Filter by name (contains)"),owner:a.string().optional().describe("Filter by owner account ID"),expand:a.string().optional().describe("Expand options: description, owner, jql, viewUrl, searchUrl, favourite, favouritedCount, sharePermissions"),startAt:a.number().int().nonnegative().optional(),maxResults:a.number().int().positive().max(50).optional().default(50)})},async({filterName:e,owner:t,expand:s,startAt:r,maxResults:a})=>{try{const i=w(await f()),n=await i.get("/rest/api/3/filter/search",{params:{filterName:e,owner:t,expand:s,startAt:r,maxResults:a??50}}),o=Array.isArray(n.data?.values)?n.data.values.map(e=>({id:e.id,name:e.name,description:e.description,owner:e.owner?.displayName,jql:e.jql,favourite:e.favourite??!1,favouritedCount:e.favouritedCount??0})):[];return D({total:n.data?.total??o.length,startAt:n.data?.startAt??0,filters:o})}catch(e){return D(A(e))}}),x.registerTool("jira_get_filter",{title:"Get Filter Details",description:"Get details of a specific filter.",inputSchema:a.object({filterId:a.string().min(1).describe("Filter ID"),expand:a.string().optional().describe("Expand options")})},async({filterId:e,expand:t})=>{try{const s=w(await f()),r=await s.get(`/rest/api/3/filter/${e}`,{params:{expand:t}});return D({id:r.data?.id,name:r.data?.name,description:r.data?.description,owner:r.data?.owner?.displayName,jql:r.data?.jql,favourite:r.data?.favourite??!1,sharePermissions:r.data?.sharePermissions})}catch(e){return D(A(e))}}),x.registerTool("jira_create_filter",{title:"Create Filter",description:"Create a new saved filter.",inputSchema:a.object({name:a.string().min(1).describe("Filter name"),jql:a.string().min(1).describe("JQL query"),description:a.string().optional().describe("Filter description"),favourite:a.boolean().optional().describe("Mark as favourite")})},async({name:e,jql:t,description:s,favourite:r})=>{try{const a=w(await f()),i=await a.post("/rest/api/3/filter",{name:e,jql:t,description:s,favourite:r});return D({success:!0,id:i.data?.id,name:i.data?.name,jql:i.data?.jql,message:`Filter "${e}" created successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_update_filter",{title:"Update Filter",description:"Update an existing filter.",inputSchema:a.object({filterId:a.string().min(1).describe("Filter ID"),name:a.string().optional().describe("New filter name"),jql:a.string().optional().describe("New JQL query"),description:a.string().optional().describe("New description"),favourite:a.boolean().optional().describe("Favourite status")})},async({filterId:e,name:t,jql:s,description:r,favourite:a})=>{try{const i=w(await f()),n={};if(void 0!==t&&(n.name=t),void 0!==s&&(n.jql=s),void 0!==r&&(n.description=r),void 0!==a&&(n.favourite=a),0===Object.keys(n).length)return D({error:"no_changes",message:"No fields provided to update"});const o=await i.put(`/rest/api/3/filter/${e}`,n);return D({success:!0,id:o.data?.id??e,name:o.data?.name,message:"Filter updated successfully"})}catch(e){return D(A(e))}}),x.registerTool("jira_delete_filter",{title:"Delete Filter",description:"Delete a saved filter.",inputSchema:a.object({filterId:a.string().min(1).describe("Filter ID to delete"),confirmDelete:a.boolean().describe("Must be true to confirm deletion")})},async({filterId:e,confirmDelete:t})=>{try{if(!t)return D({error:"confirmation_required",message:"Deletion not confirmed. Set confirmDelete: true to proceed.",filterId:e});const s=w(await f());return await s.delete(`/rest/api/3/filter/${e}`),D({success:!0,message:`Filter ${e} deleted successfully`})}catch(e){return D(A(e))}}),x.registerTool("jira_get_my_filters",{title:"Get My Filters",description:"Get filters owned by the current user.",inputSchema:a.object({expand:a.string().optional().describe("Expand options")})},async({expand:e})=>{try{const t=w(await f());return D(((await t.get("/rest/api/3/filter/my",{params:{expand:e}})).data||[]).map(e=>({id:e.id,name:e.name,description:e.description,jql:e.jql,favourite:e.favourite??!1})))}catch(e){return D(A(e))}}),x.registerTool("jira_get_favourite_filters",{title:"Get Favourite Filters",description:"Get filters marked as favourite by the current user.",inputSchema:a.object({expand:a.string().optional().describe("Expand options")})},async({expand:e})=>{try{const t=w(await f());return D(((await t.get("/rest/api/3/filter/favourite",{params:{expand:e}})).data||[]).map(e=>({id:e.id,name:e.name,description:e.description,owner:e.owner?.displayName,jql:e.jql})))}catch(e){return D(A(e))}});const R=new r;await x.connect(R);